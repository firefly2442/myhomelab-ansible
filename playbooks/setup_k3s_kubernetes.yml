---
- hosts:
  - minisforum
  - alienware
  - blueantec
  - system76laptop
  tasks:
  - name: Install required packages (needed for longhorn)
    become: true
    apt:
      name:
        - open-iscsi
        - jq
      state: latest
      install_recommends: yes
      update_cache: no
  - name: Install Helm binary
    become: true
    ansible.builtin.unarchive:
      # https://github.com/helm/helm/releases
      src: https://get.helm.sh/helm-v3.11.3-linux-amd64.tar.gz
      dest: /usr/local/bin
      extra_opts: "--strip-components=1"
      owner: root
      group: root
      mode: 0755
      remote_src: true
  - name: Download k3s script
    ansible.builtin.get_url:
      url: https://get.k3s.io
      dest: /tmp/k3s.sh
  - name: Install k3s on master
    when: inventory_hostname in ['alienware']
    become: true
    ansible.builtin.shell: cat /tmp/k3s.sh | K3S_KUBECONFIG_MODE="644" K3S_TOKEN={{ token | quote }} INSTALL_K3S_VERSION=v1.24.12+k3s1 sh -s - server --cluster-init --tls-san {{ loadbalancer | quote }} --disable servicelb
  - name: Install k3s on other nodes
    when: inventory_hostname in ['blueantec', 'minisforum']
    become: true
    ansible.builtin.shell: cat /tmp/k3s.sh | K3S_KUBECONFIG_MODE="644" K3S_TOKEN={{ token | quote }} INSTALL_K3S_VERSION=v1.24.12+k3s1 sh -s - server --server https://{{ master | quote }}:6443 --tls-san {{ loadbalancer | quote }} --disable servicelb
  - name: Install k3s on laptop with just control plane, this way no workloads get assigned
    when: inventory_hostname in ['system76laptop']
    become: true
    ansible.builtin.shell: cat /tmp/k3s.sh | K3S_KUBECONFIG_MODE="644" K3S_TOKEN={{ token | quote }} INSTALL_K3S_VERSION=v1.24.12+k3s1 sh -s - server --node-taint CriticalAddonsOnly=true:NoExecute --server https://{{ master | quote }}:6443 --tls-san {{ loadbalancer | quote }} --disable servicelb
  - name: Set load balancer IP in /etc/rancher/k3s/k3s.yaml
    become: true
    ansible.builtin.replace:
      path: /etc/rancher/k3s/k3s.yaml
      regexp: "server: https://.*:6443"
      replace: "server: https://{{ loadbalancer }}:6443"
  - name: Copy confile to home directory
    ansible.builtin.copy:
      src: /etc/rancher/k3s/k3s.yaml
      dest: ~/.kube/config
      owner: carlsonp
      group: carlsonp
      mode: u=rw,g-rwx,o-rwx
  - name: Wait for cluster handshake and spinup
    ansible.builtin.pause:
      seconds: 5
  - name: Get node status
    ansible.builtin.command: kubectl get nodes
    register: kubenodes
  - name: Show kubectl get nodes result
    ansible.builtin.debug: msg="{{ kubenodes.stdout }}"
  - name: Add Helm repos
    ansible.builtin.command: "{{ item }}"
    with_items:
      - helm repo add longhorn https://charts.longhorn.io
      - helm repo add metallb https://metallb.github.io/metallb
      - helm repo add milvus https://milvus-io.github.io/milvus-helm/
      - helm repo add rancher-stable https://releases.rancher.com/server-charts/stable
  - name: Update Helm repos
    ansible.builtin.command: helm repo update
  - name: Install metallb (load balancer)
    when: inventory_hostname in ['system76laptop']
    ansible.builtin.command: helm upgrade --install metallb metallb/metallb --create-namespace --namespace metallb-system